<?!= include('lib', data) ?>
<script>
  const thread = '<?!= data.thread ?>';

  function showFormPicker(forms) {
    replaceContent(`<form id="student-picker">
          <p>Please select the form for which to create course plans.</p>
          <div>
            <select id="gradYear" name="gradYear">
              ${forms.map(
                (form) => `<option value="${form}">Class of ${form}</option>`
              )}
            </select>
            <button class="button action" type="submit">Create Course Plans</button>
          </div>
        </form>`);
    attachEvent(
      document.getElementById('student-picker'),
      'submit',
      handleSubmit
    );
  }

  function showProgress() {
    replaceContent(`Loadingâ€¦`);
    updateProgress();
  }

  function updateProgress() {
    google.script.run
      .withSuccessHandler((progress) => {
        if (progress.complete) {
          google.script.host.close();
        } else {
          replaceContent(progress.html);
          updateProgress();
        }
      })
      .getProgress(thread);
  }

  function showResult(url) {
    replaceContent(
      `<div>Created course plan for ${student}.</div>
      <div><a id="button" class="button action" href="${url}" target="_blank">Open Plan</a></div>`
    );
    attachEvent(document.getElementById('button'), 'click', () =>
      google.script.host.close()
    );
  }

  function handleSubmit(e) {
    if (e.preventDefault) {
      e.preventDefault();
    }
    const g = document.getElementById('gradYear');
    showProgress();
    google.script.run.createAll(g.value, thread);
    return false;
  }

  google.script.run.withSuccessHandler(showFormPicker).studentGetForms();
</script>
