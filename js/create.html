<?!= include('lib', data) ?>
<script>
  const thread = '<?!= data.thread ?>';
  var student;

  function showStudentPicker(students) {
    replaceContent(`<form id="student-picker">
          <p>Please select the student for whom to create a course plan.</p>
          <div>
            <select id="student" name="student">
              ${students.map(
                (student) =>
                  `<option value="${student.hostId}">${student.firstName} ${student.lastName} â€˜${student.abbrevGradYear}</option>`
              )}
            </select>
            <button class="button action" type="submit">Create Course Plan</button>
          </div>
        </form>`);
    attachEvent(
      document.getElementById('student-picker'),
      'submit',
      handleSubmit
    );
  }

  function showProgress() {
    replaceContent(progressPlaceholder());
    updateProgressThenShowResult();
  }

  function updateProgressThenShowResult() {
    google.script.run
      .withSuccessHandler((progress) => {
        if (progress.complete) {
          showResult(progress.complete);
        } else {
          replaceContent(progress.html);
          updateProgressThenShowResult();
        }
      })
      .getProgress(thread);
  }

  function showResult(url) {
    replaceContent(
      `<div>Created course plan for ${student}.</div>
      <div><a id="button" class="button action" href="${url}" target="_blank">Open Plan</a></div>`
    );
    attachEvent(document.getElementById('button'), 'click', () =>
      google.script.host.close()
    );
  }

  function handleSubmit(e) {
    if (e.preventDefault) {
      e.preventDefault();
    }
    const s = document.getElementById('student');
    student = document.querySelector(
      `#student option[value="${s.value}"]`
    ).innerHTML;
    showProgress();
    google.script.run.createSingleFor(s.value, thread);
    return false;
  }

  google.script.run.withSuccessHandler(showStudentPicker).studentGetAll();
</script>
